package com.hello.suripu.algorithm.neuralnet;

import com.google.common.base.Optional;
import com.google.common.io.Resources;
import junit.framework.TestCase;
import org.junit.Test;

import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.List;

/**
 * Created by benjo on 2/24/16.
 */
public class TestDL4JNeuralNet {
    final static double [] ref = {1.6224533319473267, 1.5815672278404236, 1.5408334136009216, 1.5013733506202698, 1.461198329925537, 1.4211659133434296, 1.3833026587963104, 1.3463245332241058, 1.3115353882312775, 1.277061104774475, 1.2435918301343918, 1.2128083407878876, 1.1826993525028229, 1.156105399131775, 1.1307191848754883, 1.1056185513734818, 1.084049865603447, 1.0629413276910782, 1.0435940325260162, 1.0250923782587051, 1.0088863223791122, 0.993850976228714, 0.9806931763887405, 0.9673654288053513, 0.9567460417747498, 0.9461870789527893, 0.9362491220235825, 0.92800073325634, 0.9204406291246414, 0.9142142534255981, 0.907987505197525, 0.9026152640581131, 0.8978337049484253, 0.8926159888505936, 0.8898987621068954, 0.8871195465326309, 0.8842594921588898, 0.8814968168735504, 0.8798374235630035, 0.8788511157035828, 0.8774983882904053, 0.876605436205864, 0.8754977583885193, 0.8753448724746704, 0.8752623200416565, 0.8754220604896545, 0.8762610703706741, 0.8761154860258102, 0.8770192414522171, 0.8779246360063553, 0.8794518560171127, 0.8799422532320023, 0.8814404159784317, 0.8828708529472351, 0.8839534223079681, 0.8863519132137299, 0.8884613215923309, 0.8901415020227432, 0.8920709788799286, 0.8935984224081039, 0.8964003622531891, 0.8983767777681351, 0.9005904942750931, 0.902361273765564, 0.9044423699378967, 0.9076373279094696, 0.9104590862989426, 0.9118214249610901, 0.9154008328914642, 0.9179242700338364, 0.9207098931074142, 0.9240463376045227, 0.9266815334558487, 0.929531455039978, 0.9318899363279343, 0.9345444291830063, 0.9383232146501541, 0.9417004138231277, 0.9445382654666901, 0.9470848739147186, 0.9504251182079315, 0.9535861015319824, 0.9567853063344955, 0.960514098405838, 0.9629590809345245, 0.9669055044651031, 0.9688039869070053, 0.9730494767427444, 0.9765975177288055, 0.9795274585485458, 0.9820959717035294, 0.9854234755039215, 0.9884834289550781, 0.9919993579387665, 0.9945680946111679, 0.9966043382883072, 0.9964162111282349, 1.0019637644290924, 1.0056380927562714, 1.0097985714673996, 1.0129638016223907, 1.0138988494873047, 1.018446460366249, 1.0241084545850754, 1.031567007303238, 1.0380250960588455, 1.044277623295784, 1.0520774871110916, 1.058274284005165, 1.0657308995723724, 1.0736018419265747, 1.0800813883543015, 1.0878291726112366, 1.095426231622696, 1.1037086695432663, 1.1111462116241455, 1.1189273744821548, 1.1267577856779099, 1.1334504932165146, 1.1427903175354004, 1.1512936651706696, 1.1591536551713943, 1.1667297035455704, 1.1753753572702408, 1.184411197900772, 1.1924712359905243, 1.2008410692214966, 1.2085773050785065, 1.2173804640769958, 1.226518154144287, 1.2339193373918533, 1.242690086364746, 1.251768171787262, 1.2596975266933441, 1.267850250005722, 1.2752220034599304, 1.284271478652954, 1.2917238473892212, 1.2993249297142029, 1.3060329854488373, 1.3143442571163177, 1.3194923102855682, 1.327764093875885, 1.3345889747142792, 1.3402341306209564, 1.3451145589351654, 1.3507644832134247, 1.355617493391037, 1.3607192039489746, 1.3640770316123962, 1.3664638996124268, 1.3694442808628082, 1.3714034855365753, 1.3726620376110077, 1.3731876015663147, 1.3736724853515625, 1.3713334500789642, 1.3697034120559692, 1.3675592839717865, 1.3632340729236603, 1.3582459092140198, 1.3521818816661835, 1.3442213833332062, 1.3355571031570435, 1.3273639976978302, 1.316511332988739, 1.30557119846344, 1.2915325164794922, 1.2785451114177704, 1.262235939502716, 1.247047707438469, 1.2295003980398178, 1.2106355279684067, 1.192159280180931, 1.1722815036773682, 1.1540988087654114, 1.1350558698177338, 1.117769405245781, 1.100115329027176, 1.0854484885931015, 1.0737453401088715, 1.0640543699264526, 1.0574272274971008, 1.0510971397161484, 0.9812162071466446, 0.7010993361473083, 0.5543713271617889, 0.5202570930123329, 0.48618409782648087, 0.4623078182339668, 0.40529727935791016, 0.3954288735985756, 0.3919631987810135, 0.3887217864394188, 0.3615031763911247, 0.347694456577301, 0.3466292843222618, 0.3522411361336708, 0.34223634749650955, 0.34681856632232666, 0.3392630070447922, 0.33653855323791504, 0.3449629992246628, 0.3559482470154762, 0.36974068731069565, 0.3865464776754379, 0.4047859460115433, 0.43184567242860794, 0.4639611393213272, 0.5009603872895241, 0.5492266267538071, 0.6238735467195511, 0.7051673531532288, 0.8184678852558136, 0.9765174239873886, 1.166408285498619, 1.3625802099704742, 1.6024430096149445, 1.833469569683075, 2.091444730758667, 2.324672192335129, 2.510444223880768, 2.735276520252228, 2.96886146068573, 3.1910118460655212, 3.3825984597206116, 3.5505881905555725, 3.6778122186660767, 3.848203718662262, 3.9691901206970215, 4.107624292373657, 4.214391112327576, 4.330772161483765, 4.483833909034729, 4.610819518566132, 4.757946133613586, 4.8794859647750854, 5.021106600761414, 5.079660415649414, 5.126180648803711, 5.181107521057129, 5.252819657325745, 5.311477184295654, 5.380612015724182, 5.444236993789673, 5.498983860015869, 5.537863373756409, 5.563642978668213, 5.582398772239685, 5.593398809432983, 5.596421957015991, 5.595213770866394, 5.576702952384949, 5.538022518157959, 5.4821330308914185, 5.409659743309021, 5.495184659957886, 5.657970309257507, 5.809302926063538, 5.921589136123657, 6.016761660575867, 6.086171269416809, 6.161367297172546, 6.227084994316101, 6.29069447517395, 6.343966722488403, 6.38923704624176, 6.43570601940155, 6.480847597122192, 6.5183985233306885, 6.5542250871658325, 6.585988402366638, 6.621689796447754, 6.659409999847412, 6.701025366783142, 6.744316816329956, 6.794150471687317, 6.833001375198364, 6.878001093864441, 6.9250911474227905, 6.973933577537537, 7.02764093875885, 7.080576419830322, 7.1392518281936646, 7.2062695026397705, 7.2775644063949585, 7.352636456489563, 7.430334091186523, 7.512637376785278, 7.597516775131226, 7.6830679178237915, 7.769121527671814, 7.856130599975586, 7.940934896469116, 8.023228645324707, 8.104431629180908, 8.182891011238098, 8.256561756134033, 8.32335352897644, 8.313249945640564, 8.34263563156128, 8.414687514305115, 8.482678532600403, 8.546791076660156, 8.610339760780334, 8.673402667045593, 8.734655976295471, 8.797183632850647, 8.85972261428833, 8.923481702804565, 8.984485268592834, 9.04551088809967, 9.105188846588135, 9.162402153015137, 9.217788577079773, 9.272657632827759, 9.322577118873596, 9.370864033699036, 9.41385805606842, 9.451766014099121, 9.486774206161499, 9.516957402229309, 9.544041156768799, 9.566495418548584, 9.586837887763977, 9.604754447937012, 9.618610739707947, 9.6321702003479, 9.64209258556366, 9.649219512939453, 9.652392864227295, 9.642568230628967, 9.637523889541626, 9.63821291923523, 9.627612233161926, 9.615561366081238, 9.619818925857544, 9.627074599266052, 9.634058475494385, 9.63891863822937, 9.644526839256287, 9.646666646003723, 9.65151309967041, 9.65760052204132, 9.663995504379272, 9.668384194374084, 9.669281244277954, 9.67089295387268, 9.672017097473145, 9.673796892166138, 9.675361514091492, 9.67705249786377, 9.678351879119873, 9.679876565933228, 9.681286215782166, 9.682250618934631, 9.682314395904541, 9.681995511054993, 9.683048725128174, 9.684373140335083, 9.686853885650635, 9.690349698066711, 9.69456672668457, 9.699332118034363, 9.70415711402893, 9.708477258682251, 9.712103605270386, 9.713976979255676, 9.713951349258423, 9.711570739746094, 9.703237414360046, 9.68802034854889, 9.643915891647339, 9.625073671340942, 9.612634778022766, 9.611930847167969, 9.612312912940979, 9.611684083938599, 9.6100515127182, 9.607580304145813, 9.604260325431824, 9.60062026977539, 9.591672420501709, 9.587351083755493, 9.586782455444336, 9.586087465286255, 9.585115313529968, 9.5844566822052, 9.582999348640442, 9.582131505012512, 9.580078721046448, 9.577674269676208, 9.57490861415863, 9.566088318824768, 9.559852480888367, 9.560196995735168, 9.562830924987793, 9.564377069473267, 9.565094709396362, 9.56260085105896, 9.562799334526062, 9.561449885368347, 9.559595584869385, 9.561301469802856, 9.563939571380615, 9.564708471298218, 9.566946029663086, 9.567567706108093, 9.568681120872498, 9.570341110229492, 9.57348346710205, 9.577745199203491, 9.582473039627075, 9.58352267742157, 9.58200216293335, 9.583837985992432, 9.585012197494507, 9.583660960197449, 9.580467939376831, 9.581088423728943, 9.580751657485962, 9.577026963233948, 9.571560025215149, 9.56213116645813, 9.548134207725525, 9.528387784957886, 9.499393105506897, 9.413525462150574, 9.395609498023987, 9.370465874671936, 9.34154987335205, 9.334707856178284, 9.350457787513733, 9.363989233970642, 9.376033544540405, 9.382273554801941, 9.38037633895874, 9.374881386756897, 9.37837541103363, 9.39004898071289, 9.405661225318909, 9.416497945785522, 9.420687556266785, 9.431542158126831, 9.441555738449097, 9.449177980422974, 9.460204243659973, 9.469284415245056, 9.478126168251038, 9.486666917800903, 9.494929909706116, 9.502730965614319, 9.510645270347595, 9.518147706985474, 9.525337815284729, 9.53218400478363, 9.538634419441223, 9.544793963432312, 9.55007791519165, 9.554837942123413, 9.558133482933044, 9.562371969223022, 9.564762711524963, 9.565808176994324, 9.562076330184937, 9.558789134025574, 9.55780565738678, 9.555856585502625, 9.543800950050354, 9.530476331710815, 9.52392578125, 9.52468454837799, 9.524014592170715, 9.528087377548218, 9.528993964195251, 9.528349041938782, 9.530154466629028, 9.53657865524292, 9.54293668270111, 9.548577666282654, 9.55309808254242, 9.55481767654419, 9.557403922080994, 9.558558464050293, 9.558334946632385, 9.558014869689941, 9.557464718818665, 9.563842415809631, 9.569804072380066, 9.57545816898346, 9.577314853668213, 9.579272270202637, 9.580788612365723, 9.584786295890808, 9.58926796913147, 9.597719311714172, 9.603025913238525, 9.607422947883606, 9.613695740699768, 9.61746633052826, 9.623395204544067, 9.628052115440369, 9.628838896751404, 9.629368782043457, 9.628392457962036, 9.627748131752014, 9.623581171035767, 9.607509970664978, 9.606366753578186, 9.586654901504517, 9.582976698875427, 9.574626684188843, 9.537389278411865, 9.460777044296265, 9.485933184623718, 9.514955878257751, 9.529891610145569, 9.546877145767212, 9.563928842544556, 9.579311609268188, 9.59288775920868, 9.605640769004822, 9.61738109588623, 9.628461003303528, 9.638276100158691, 9.648308753967285, 9.65580403804779, 9.6612149477005, 9.649912118911743, 9.649630188941956, 9.65395450592041, 9.658486247062683, 9.662164449691772, 9.663845300674438, 9.66543734073639, 9.66782808303833, 9.667246341705322, 9.667471647262573, 9.669876098632812, 9.670947790145874, 9.671226143836975, 9.668080806732178, 9.665371775627136, 9.661901593208313, 9.653812646865845, 9.642425179481506, 9.631853103637695, 9.587532877922058, 9.571519494056702, 9.573276042938232, 9.56364631652832, 9.544287323951721, 9.45240318775177, 9.482234120368958, 9.426772594451904, 9.44295346736908, 9.439026117324829, 9.44738507270813, 9.460741877555847, 9.465555548667908, 9.470359683036804, 9.47952687740326, 9.488437175750732, 9.494701027870178, 9.500950574874878, 9.505613446235657, 9.508748054504395, 9.510532021522522, 9.512682557106018, 9.514144659042358, 9.513335227966309, 9.511092901229858, 9.509497284889221, 9.506441950798035, 9.50154185295105, 9.493904709815979, 9.485191702842712, 9.47446584701538, 9.461581707000732, 9.448359608650208, 9.429242610931396, 9.409598112106323, 9.390222430229187, 9.366649985313416, 9.34154748916626, 9.307595491409302, 9.270431995391846, 9.230032563209534, 9.188578724861145, 9.135781526565552, 9.077355861663818, 9.005841612815857, 8.929381370544434, 8.832980990409851, 8.699537515640259, 8.459047079086304, 8.519030809402466, 8.533194661140442, 8.515382409095764, 8.481029272079468, 8.429489135742188, 8.36277186870575, 8.288164734840393, 8.194177150726318, 8.08254063129425, 7.931234240531921, 7.819544076919556, 7.499619126319885, 7.4459511041641235, 7.171200513839722, 6.965523362159729, 7.016801238059998, 7.337332367897034, 7.5203245878219604, 7.6539599895477295, 7.593652606010437, 7.702111601829529, 7.873771786689758, 7.984962463378906, 8.09915840625763, 8.186700344085693, 8.253605365753174, 8.29826831817627, 8.346033096313477, 8.369717001914978, 8.392037749290466, 8.412143588066101, 8.44177782535553, 8.45318078994751, 8.458139896392822, 8.468007445335388, 8.465641736984253, 8.472391366958618, 8.472166657447815, 8.47402036190033, 8.473053574562073, 8.460102677345276, 8.450320959091187, 8.44419538974762, 8.439621925354004, 8.432793021202087, 8.422457575798035, 8.408946990966797, 8.392429947853088, 8.373681902885437, 8.350237011909485, 8.323643803596497, 8.296300172805786, 8.262850642204285, 8.2221519947052, 8.190709948539734, 8.1435227394104, 8.093017935752869, 8.034971356391907, 7.965497970581055, 7.900063991546631, 7.816938161849976, 7.719598412513733, 7.610189318656921, 7.487195730209351, 7.17920184135437, 7.026041746139526, 6.970385909080505, 6.922405362129211, 6.871697306632996, 6.8089282512664795, 6.733615398406982, 6.61503791809082, 6.503862738609314, 6.421060562133789, 5.973004102706909, 5.9112876653671265, 5.872568488121033, 5.832895040512085, 5.782527327537537, 5.724833607673645, 5.648692846298218, 5.551937222480774, 5.478975176811218, 5.439484119415283, 5.282440185546875, 5.037670135498047, 4.480872452259064, 4.411822557449341, 4.351513981819153, 4.264439940452576, 4.1583168506622314, 4.10308837890625, 4.108801186084747, 4.081767201423645, 4.077872335910797, 3.9456796646118164, 3.393963575363159, 2.0375803112983704, 1.0749341547489166, 0.627768337726593, 0.41640739887952805, 0.31798742711544037, 0.26946617290377617, 0.2432463876903057, 0.22787431254982948, 0.2182389795780182, 0.21180490031838417, 0.20811865106225014, 0.19745247438549995, 0.1959686540067196, 0.19523752853274345, 0.19594820216298103, 0.19543834030628204, 0.19635185599327087, 0.19730053842067719, 0.19818544387817383, 0.19903987646102905, 0.19979624077677727, 0.20050406455993652, 0.2011580765247345, 0.2017037384212017, 0.20214693620800972, 0.2025485597550869, 0.20285863429307938, 0.20309213548898697, 0.20334772765636444, 0.20359965041279793, 0.20378902554512024, 0.20394373685121536, 0.20406419411301613, 0.20412547513842583, 0.20416857674717903, 0.20425967872142792, 0.20433612167835236, 0.20435897633433342, 0.20429860800504684, 0.20425103604793549, 0.2041441947221756, 0.2041650377213955, 0.2041635476052761, 0.2041896991431713, 0.20417524501681328, 0.2041405625641346, 0.20399905741214752, 0.20388534292578697, 0.2038133144378662, 0.2038135565817356, 0.20381439477205276, 0.20374901592731476, 0.20369619131088257, 0.2035406231880188, 0.20337997004389763, 0.20320625975728035, 0.20317446440458298, 0.20317722111940384, 0.2030070684850216, 0.2032225951552391, 0.20304333418607712, 0.20303023979067802, 0.20294183865189552, 0.2033298835158348, 0.20249823108315468, 0.2025013230741024, 0.20254597067832947, 0.20252609625458717, 0.20243274047970772, 0.20248191431164742, 0.20227842032909393, 0.20202402025461197, 0.2017655223608017, 0.20179403945803642, 0.20192917436361313, 0.202277023345232, 0.2025674469769001, 0.2027135156095028, 0.20239276811480522, 0.20217157900333405, 0.20220020785927773, 0.20240748301148415, 0.2026868797838688, 0.2019285038113594, 0.2015366218984127, 0.2014063112437725, 0.20126432180404663, 0.2015259675681591, 0.20195964723825455, 0.20212918519973755, 0.20192565396428108, 0.2021055482327938, 0.2021777257323265, 0.20229743793606758, 0.20249657332897186, 0.20263651385903358, 0.20290665328502655, 0.20337967202067375, 0.20376572385430336, 0.20387928932905197, 0.2039717696607113, 0.20429184660315514, 0.20459989085793495, 0.20488670095801353, 0.20503459498286247, 0.20477887243032455, 0.20426208153367043, 0.204039104282856, 0.2038237266242504, 0.20344125106930733, 0.2031945437192917, 0.20306700840592384, 0.20303962752223015, 0.2031279169023037, 0.20346909761428833, 0.20363673567771912, 0.20371155813336372, 0.20387334749102592, 0.20376447588205338, 0.2037564292550087, 0.20392883569002151, 0.20399335771799088, 0.20398907363414764, 0.20383363589644432, 0.20350662991404533, 0.20331844687461853, 0.20310401916503906, 0.20300604403018951, 0.2031281590461731, 0.20321214571595192, 0.20325200632214546, 0.20323341712355614, 0.20350901409983635, 0.20360933616757393, 0.20418662577867508, 0.20367488265037537, 0.20380031317472458, 0.20364783704280853, 0.2036183699965477, 0.20346984267234802, 0.2035408653318882, 0.20375356078147888, 0.2037976123392582, 0.20390231162309647, 0.20380135625600815, 0.2036721259355545, 0.20368466153740883, 0.2038157358765602, 0.20402375608682632, 0.20404720678925514, 0.2041727863252163, 0.20421981811523438, 0.20410418510437012, 0.20443396642804146, 0.20442957058548927, 0.20455669611692429, 0.2052159234881401, 0.20563391968607903, 0.20495349541306496, 0.20454803481698036, 0.2051033079624176, 0.2050001174211502, 0.20499629899859428, 0.20519090816378593, 0.20540403202176094, 0.20553374662995338, 0.20598644390702248, 0.20617978647351265, 0.2064375951886177, 0.2064550668001175, 0.2069982886314392, 0.20740589126944542, 0.2075033076107502, 0.2079492248594761, 0.20768530666828156, 0.20745161920785904, 0.20738067105412483, 0.20747391507029533, 0.20770300179719925, 0.20733961835503578, 0.2079853042960167, 0.20883768796920776, 0.20960351452231407, 0.2100568450987339, 0.21062226966023445, 0.21101078018546104, 0.21066946908831596, 0.21016925573349, 0.20977575331926346, 0.2088569849729538, 0.20872702822089195, 0.2085869386792183, 0.2087295614182949, 0.20885761827230453, 0.20927619189023972, 0.20963026210665703, 0.21041534841060638, 0.211006049066782, 0.21132893860340118, 0.21172534674406052, 0.21209880709648132, 0.21251656115055084, 0.21291835233569145, 0.21344760432839394, 0.21396765485405922, 0.21461514756083488, 0.21526949480175972, 0.21573925390839577, 0.21595420315861702, 0.2159787341952324, 0.21633252501487732, 0.2169409953057766, 0.21722016856074333, 0.21705476567149162, 0.21807368844747543, 0.21904129534959793, 0.2191869542002678, 0.21982131525874138, 0.22041566669940948, 0.22075993940234184, 0.22163428366184235, 0.22250181064009666, 0.22349782288074493, 0.22482413798570633, 0.22661522030830383, 0.22849936038255692, 0.2301354706287384, 0.23184819146990776, 0.23369699716567993, 0.23520544171333313, 0.23731477558612823, 0.23881103843450546, 0.24114787578582764, 0.2434481866657734, 0.24600351229310036, 0.24890707805752754, 0.25145623832941055, 0.2539217658340931, 0.25722842663526535, 0.2604507841169834, 0.26418736204504967, 0.26822665706276894, 0.2718028798699379, 0.27597181499004364, 0.2811209484934807, 0.2872013673186302, 0.29504986479878426, 0.30287256464362144, 0.311995018273592, 0.32406505197286606, 0.3372688591480255, 0.3532642498612404, 0.37256263196468353, 0.39766591042280197, 0.42997825890779495, 0.46696797013282776, 0.5211836472153664, 0.592300146818161, 0.6887450814247131, 0.8183746784925461, 0.9843380749225616, 1.187547817826271, 1.4354346692562103, 1.7319147288799286, 2.059846520423889, 2.411506623029709, 2.763630747795105, 3.1185242533683777};


    @Test
    public void testEvaluation() {
        final URL paramsUrl = Resources.getResource("neuralnet/2016-02-24T21:06:20.084Z.params");
        final URL configUrl = Resources.getResource("neuralnet/2016-02-24T21:06:20.084Z.config");
        final URL dataUrl = Resources.getResource("neuralnet/simpledata.csv");

        try {
            final byte[] paramsdata = Files.readAllBytes(Paths.get(paramsUrl.toURI()));
            final List<String> configDataLines = Files.readAllLines(Paths.get(configUrl.toURI()), Charset.defaultCharset());
            final List<String> sensorDataLines = Files.readAllLines(Paths.get(dataUrl.toURI()), Charset.defaultCharset());

            String configData = "";

            for (final String line : configDataLines) {
                configData += line;
            }


            final Optional<NeuralNetEvaluator> evaluatorOptional =
                    NeuralNetEvaluator.createFromBinDataAndConfig(paramsdata, configData);

            TestCase.assertTrue(evaluatorOptional.isPresent());


            final double[][] x = new double[sensorDataLines.size()][0];

            for (int iLine = 0; iLine < sensorDataLines.size(); iLine++) {
                final String[] values = sensorDataLines.get(iLine).split(",");

                final double[] vec = new double[values.length];

                for (int i = 0; i < values.length; i++) {
                    vec[i] = Double.valueOf(values[i]);
                }

                x[iLine] = vec;
            }


            final NeuralNetEvaluator evaluator = evaluatorOptional.get();

            final double[][] y = evaluator.evaluate(x);

            TestCase.assertTrue(ref.length == y[1].length);

            for (int t = 0; t < ref.length; t++) {
                TestCase.assertEquals(ref[t],y[1][t]*10.0,1e-4);
            }

        } catch (IOException e) {
            TestCase.assertTrue(false);
        } catch (URISyntaxException e) {
            TestCase.assertTrue(false);
        }




    }
}
